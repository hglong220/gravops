# 用户授权类目功能使用说明

## 📋 功能概述

这个功能解决了一个关键问题：**每个政采云账号只有部分类目的上传权限**。

### 🎯 核心价值

1. **避免上传失败**：选择无权限的类目会导致上传失败
2. **提升用户体验**：只显示用户有权限的类目，不会造成困扰
3. **自动扩展子类目**：如果你有"办公用品"权限，系统会自动显示其下所有2级、3级、4级、5级类目

---

## 🔄 工作流程

```
┌─────────────────────────────┐
│  首次使用编辑功能            │
└──────────┬──────────────────┘
           │
           ▼
┌─────────────────────────────┐
│  检测是否有用户授权类目      │
└──────────┬──────────────────┘
           │
      没有 │ 有
           ├─────────────┐
           │             │
           ▼             ▼
┌──────────────┐  ┌──────────────┐
│ 提示抓取     │  │ 直接显示     │
│ 点击按钮     │  │ 授权类目     │
└──────┬───────┘  └──────────────┘
       │
       ▼
┌──────────────┐
│ 打开浏览器   │
│ 访问政采云   │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ 自动抓取     │
│ 授权类目     │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ 扩展所有     │
│ 子类目       │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ 保存到数据库 │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ 编辑时只显示 │
│ 这些类目     │
└──────────────┘
```

---

## 💡 使用方法

### 方法1：在编辑页面使用（推荐）

```tsx
// 在编辑商品时，传入onlyAuthorized=true
<CategorySelector 
  onlyAuthorized={true}     // 只显示用户授权的类目
  userId={currentUser.id}   // 当前用户ID
  onChange={handleCategoryChange}
/>
```

**首次使用**：
1. 会看到一个橙色提示框："需要抓取授权类目"
2. 点击"立即抓取我的授权类目"按钮
3. 浏览器会自动打开政采云页面
4. 系统自动抓取你的7个授权类目
5. 自动扩展为包含所有子类目（可能有几百个）
6. 保存到数据库
7. 编辑页面刷新，显示你的授权类目

**后续使用**：
- 直接显示你的授权类目
- 顶部有蓝色提示："当前显示您有权限的 7 个类目"

---

### 方法2：手动抓取授权类目

```bash
# 调用API
POST /api/user/fetch-categories
Headers: x-user-id: <用户ID>

# 响应
{
  "success": true,
  "message": "授权类目抓取成功",
  "data": {
    "totalCategories": 542,  // 包含所有子类目
    "topLevelCategories": 7,  // 7个一级类目
    "fetchedAt": "2025-11-29T..."
  }
}
```

---

### 方法3：查询用户授权类目

```bash
# 调用API
GET /api/user/categories
Headers: x-user-id: <用户ID>

# 响应
{
  "success": true,
  "categories": [ /* 542个类目 */ ],
  "summary": {
    "total": 542,
    "level1": 7,
    "level2": 85,
    "level3": 450
  }
}
```

---

## 📊 示例：7个一级类目扩展

假设你的政采云账号有以下7个授权类目：

### 一级类目（你的权限）
1. 办公用品
2. 办公设备
3. 日用百货
4. 计算机设备
5. 劳动保护用品
6. 灯具家具
7. 五金工具

### 系统自动扩展后

```
办公用品 (1个)
├─ 笔类 (1个)
│  ├─ 中性笔 (1个)
│  ├─ 钢笔 (1个)
│  └─ 铅笔 (1个)
├─ 纸张 (1个)
│  ├─ A4纸 (1个)
│  ├─ 打印纸 (1个)
│  └─ ...
└─ ...

办公设备 (1个)
├─ 打印机 (1个)
│  ├─ 激光打印机 (1个)
│  ├─ 喷墨打印机 (1个)
│  └─ ...
└─ ...

... （其他5个）

总计：7个一级 → 可能扩展到500+个子类目
```

---

## 🎯 对比说明

### 不使用授权过滤（旧方式）

```tsx
// 显示全部18,575个类目
<CategorySelector />
```

**问题**：
- ❌ 用户可能选择无权限的类目
- ❌ 导致上传失败："您没有该类目的上传权限"
- ❌ 用户困惑："为什么这个类目不能用？"

### 使用授权过滤（新方式）⭐

```tsx
// 只显示用户有权限的类目
<CategorySelector 
  onlyAuthorized={true}
  userId={user.id}
/>
```

**优势**：
- ✅ 只显示7个授权类目及其子类目
- ✅ 100%可以上传
- ✅ 用户体验好，不会困惑

---

## 🔧 技术实现

### 抓取逻辑

```typescript
// 1. 监听政采云API
page.on('response', async (response) => {
  if (url.includes('category') && url.includes('auth')) {
    // 捕获授权类目数据
    const categories = extractAuthedCategories(data);
  }
});

// 2. 访问政采云商品发布页
await page.goto('https://www.zcygov.cn/goods-center/goods/publish');

// 3. 触发类目加载
await page.click('.category-selector');

// 4. 扩展所有子类目
const fullCategories = expandChildren(authedCategories);
//   如果有"办公用品"权限
//   → 找到"办公用品"的所有2级子类目
//   → 找到每个2级的所有3级子类目
//   → ...

// 5. 保存
await saveUserCategories(userId, fullCategories);
```

### 数据存储

```json
{
  "userId": "user-123",
  "categories": [
    {
      "id": 4402,
      "name": "办公用品",
      "categoryCode": "4402",
      "level": 1,
      "authed": true
    },
    {
      "id": 4440,
      "name": "笔类/书写工具",
      "categoryCode": "4440",
      "level": 2,
      "parentId": 4402,
      "authed": true
    },
    // ... 更多子类目
  ],
  "updatedAt": "2025-11-29T..."
}
```

---

## ⚠️ 注意事项

### 1. 首次抓取需要登录

- 抓取时会打开浏览器访问政采云
- 请确保已登录
- 抓取过程约15-30秒

### 2. 授权类目可能变化

- 建议每月重新抓取一次
- 如果政采云给你新增了类目权限，需要重新抓取

### 3. 子类目自动扩展

- 系统会自动扩展所有子类目
- 7个一级类目可能扩展到500-1000个子类目
- 这些都是你有权限使用的

---

## 💡 常见问题

### Q1: 我有7个授权类目，为什么只显示5个？

A: 可能是：
1. 有2个类目在政采云没有子类目
2. 或者数据抓取时遗漏了

解决：重新点击"抓取授权类目"

### Q2: 我在政采云新增了类目权限，怎么刷新？

A: 重新抓取即可：
```javascript
// 调用API
POST /api/user/fetch-categories
```

或者在编辑页面，删除旧数据后会提示重新抓取。

### Q3: 抓取失败怎么办？

A: 可能原因：
1. 未登录政采云 → 先登录
2. 网络问题 → 重试
3. 政采云页面改版 → 需要更新抓取脚本

---

## 🎉 总结

这个功能确保：
1. ✅ **用户只看到有权限的类目**
2. ✅ **100%上传成功**
3. ✅ **体验流畅**
4. ✅ **自动扩展子类目**

**立即在编辑功能中启用吧！** 🚀
