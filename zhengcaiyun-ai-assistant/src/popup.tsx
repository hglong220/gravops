import { useState, useEffect } from "react";
import { useAppStore } from "~src/store/app-store";
import { getStoredLicense, verifyLicense, storeLicense } from "~src/utils/license";
import { isHighRiskProduct } from "~src/utils/trojan-strategy";
import logo from "data-base64:../assets/logo.png";

import "./style.css";

function IndexPopup() {
    const {
        isActivated,
        companyName,
        setLicense,
        reset
    } = useAppStore();

    const [inputLicense, setInputLicense] = useState("");
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState("");
    const [productName, setProductName] = useState("");
    const [currentUrl, setCurrentUrl] = useState("");

    useEffect(() => {
        checkLocalLicense();
        checkCurrentTab();
    }, []);

    const checkCurrentTab = async () => {
        const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
        if (tab?.url) {
            setCurrentUrl(tab.url);
        }
    };

    const checkLocalLicense = async () => {
        const stored = await getStoredLicense();
        if (stored) {
            setLicense(stored.licenseKey, stored.companyName, 0);
        }
    };

    const handleActivate = async () => {
        if (!inputLicense.trim()) {
            setError("è¯·è¾“å…¥æˆæƒç ");
            return;
        }

        setLoading(true);
        setError("");

        try {
            const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });

            if (!tab.url?.includes('zcygov.cn')) {
                setError("è¯·å…ˆæ‰“å¼€æ”¿é‡‡äº‘ç½‘ç«™å¹¶ç™»å½•");
                setLoading(false);
                return;
            }

            const result = await chrome.scripting.executeScript({
                target: { tabId: tab.id! },
                func: () => {
                    const element = document.querySelector('.company-name');
                    return element?.textContent?.trim() || null;
                }
            });

            const zcyCompanyName = result[0]?.result;

            if (!zcyCompanyName) {
                setError("æ— æ³•ä»æ”¿é‡‡äº‘æå–å…¬å¸åç§°ï¼Œè¯·ç¡®ä¿å·²ç™»å½•");
                setLoading(false);
                return;
            }

            const verifyResult = await verifyLicense(inputLicense, zcyCompanyName);

            if (!verifyResult.valid) {
                setError(verifyResult.error || "æˆæƒéªŒè¯å¤±è´¥");
                setLoading(false);
                return;
            }

            await storeLicense(inputLicense, zcyCompanyName);
            setLicense(inputLicense, zcyCompanyName, verifyResult.expiresAt || 0);

            setInputLicense("");
        } catch (err) {
            console.error(err);
            setError("æ¿€æ´»å¤±è´¥: " + (err instanceof Error ? err.message : "æœªçŸ¥é”™è¯¯"));
        } finally {
            setLoading(false);
        }
    };

    const handleDeactivate = () => {
        reset();
        chrome.storage.local.remove('license');
    };

    const handleUpload = async () => {
        if (!productName.trim()) {
            alert("è¯·è¾“å…¥å•†å“åç§°");
            return;
        }

        setLoading(true);
        try {
            const stored = await getStoredLicense();
            if (!stored) {
                throw new Error("License not found");
            }

            // 1. Check Risk
            const { isRisk, safeName } = await isHighRiskProduct(productName, stored.licenseKey);

            let useTrojan = false;
            if (isRisk) {
                useTrojan = confirm(`âš ï¸ æ£€æµ‹åˆ°"${productName}"å±äºé«˜é£é™©æ•æ„Ÿå•†å“ã€‚\n\nå»ºè®®ä½¿ç”¨â€œæœ¨é©¬ç­–ç•¥â€ï¼š\n1. å…ˆä¸Šä¼ å®‰å…¨æ›¿ä»£å“ (${safeName || 'åŠå…¬é…ä»¶'})\n2. ç­‰å¾…å®¡æ ¸é€šè¿‡\n3. è‡ªåŠ¨æ›¿æ¢ä¸ºçœŸå®å•†å“\n\næ˜¯å¦å¯ç”¨å®‰å…¨ç­–ç•¥ï¼Ÿ`);
            }

            // 2. Create Task
            const task = {
                id: Date.now().toString(),
                step: useTrojan ? 'init' : 'replacing', // replacing step uploads original product
                safeName: safeName,
                originalProduct: {
                    name: productName,
                    description: 'è‡ªåŠ¨ç”Ÿæˆçš„å•†å“æè¿°...', // Should be generated by AI in real app
                    category: '', // Auto-detect
                    images: [], // Auto-search
                    price: '0',
                    stock: '100'
                },
                startTime: Date.now()
            };

            await chrome.storage.local.set({ 'trojan_task': task });

            // 3. Trigger Worker
            const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
            if (tab.id) {
                // Navigate to publish page to start the worker
                await chrome.tabs.update(tab.id, { url: 'https://www.zcygov.cn/publish' });
                window.close(); // Close popup
            }

        } catch (err) {
            console.error(err);
            alert("å¯åŠ¨å¤±è´¥: " + (err instanceof Error ? err.message : "æœªçŸ¥é”™è¯¯"));
            setLoading(false);
        }
    };

    const handleOneClickCopy = async () => {
        const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
        if (tab?.id) {
            // Send message to content script (zcy-scraper.tsx)
            // Or inject script to click the button we injected
            chrome.scripting.executeScript({
                target: { tabId: tab.id },
                func: () => {
                    const btn = document.getElementById('zcy-copy-btn');
                    if (btn) {
                        btn.click();
                    } else {
                        alert('è¯·ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆæˆ–åˆ·æ–°é‡è¯•');
                    }
                }
            });
            window.close();
        }
    };

    if (!isActivated) {
        return (
            <div className="popup-container">
                <div className="header">
                    <div className="logo-container">
                        <img src={logo} alt="Logo" className="logo" />
                        <h1>æ”¿é‡‡äº‘æ™ºèƒ½åŠ©æ‰‹</h1>
                        <p className="subtitle">AI-Powered Automation</p>
                    </div>
                </div>

                <div className="content">
                    <div className="activation-form">
                        <input
                            type="text"
                            placeholder="è¯·è¾“å…¥æˆæƒç "
                            value={inputLicense}
                            onChange={(e) => setInputLicense(e.target.value)}
                            disabled={loading}
                        />

                        {error && <div className="error">{error}</div>}

                        <button
                            onClick={handleActivate}
                            disabled={loading}
                            className="btn-primary"
                        >
                            {loading ? "éªŒè¯ä¸­..." : "æ¿€æ´»"}
                        </button>

                        <div className="hint">
                            ğŸ’¡ æç¤ºï¼šè¯·å…ˆç™»å½•æ”¿é‡‡äº‘ç½‘ç«™ï¼Œç„¶åè¿”å›æ­¤å¤„æ¿€æ´»
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    return (
        <div className="popup-container">
            <div className="header">
                <div className="logo-container">
                    <img src={logo} alt="Logo" className="logo" />
                    <h1>æ”¿é‡‡äº‘æ™ºèƒ½åŠ©æ‰‹</h1>
                    <div className="activated-badge">âœ“ å·²æ¿€æ´»</div>
                </div>
            </div>

            <div className="content">
                <div className="license-info">
                    <div className="info-row">
                        <span className="label">å…¬å¸ï¼š</span>
                        <span className="value">{companyName}</span>
                    </div>
                </div>

                {currentUrl.includes('zcygov.cn/product/') ? (
                    <div className="actions">
                        <div className="hint">æ£€æµ‹åˆ°æ”¿é‡‡äº‘å•†å“é¡µ</div>
                        <button
                            className="btn-primary"
                            style={{ background: '#52c41a' }}
                            onClick={handleOneClickCopy}
                        >
                            ğŸ“‹ ä¸€é”®å¤åˆ¶æ­¤å•†å“
                        </button>
                        <button
                            className="btn-secondary"
                            onClick={() => setCurrentUrl('')}>
                            è¿”å›æ‰‹åŠ¨è¾“å…¥
                        </button>
                    </div>
                ) : (
                    <>
                        <div className="form-group">
                            <label>å•†å“åç§°</label>
                            <input
                                type="text"
                                placeholder="è¯·è¾“å…¥å•†å“åç§°"
                                value={productName}
                                onChange={(e) => setProductName(e.target.value)}
                            />
                        </div>

                        <div className="actions">
                            <button
                                className="btn-primary"
                                onClick={handleUpload}
                                disabled={loading}
                            >
                                {loading ? "å¤„ç†ä¸­..." : "ğŸš€ æ™ºèƒ½ä¸Šä¼ "}
                            </button>

                            <button
                                className="btn-secondary"
                                onClick={handleDeactivate} disabled={loading}>
                                å–æ¶ˆæ¿€æ´»
                            </button>
                        </div>
                    </>
                )}

                <div className="hint">
                    ğŸ“Œ æ ¸å¿ƒAIåŠŸèƒ½å·²å¼€å‘å®Œæˆï¼
                </div>
            </div>
        </div>
    );
}

export default IndexPopup;